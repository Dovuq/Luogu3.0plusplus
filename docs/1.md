源链接<https://www.luogu.com.cn/paste/mmuza7hy>

# Luogu 3.0++ 语言用户手册（上）——语法基础

**Luogu 3.0++**（确定性三栈洛谷自动机，Deterministic Luogu Automaton with Three Stacks）是上海洛谷网络科技有限公司于 2021 年推出的计算机语言。
Luogu 3.0++ 由两部分组成：存储器部分，和自动机部分。

## 存储器
Luogu 3.0++ 的存储器部分由三个栈构成，分别称为**栈 A**，**栈 B** 和**栈 C**。
程序的输入可以存储在栈中，然后通过自动机部分执行对数据的处理。
在自动机部分中，每种不同类型的结点可以根据栈顶的数据对栈执行不同的操作，包括对某个栈的**入栈**（push）、**出栈**（pop）等操作。
栈内元素的运算默认对 $p$ 取模，其中 $p = 998244353 = 119 \times 2^{23} + 1$，即元素值域为 $[0, p)$。
- 特殊地，整数除法和整数取模不受影响。
每个栈的最大长度为 ${10}^6$，如果试图对长度为 ${10}^6$ 的栈进行**入栈**（push）操作，则会得到 **`STACK_OVERFLOW`** 的运行时错误提示信息。
如果试图对空栈进行**出栈**（pop）操作，则会得到 **`STACK_UNDERFLOW`** 的运行时错误提示信息。
如果试图对空栈的栈顶进行访问（即获取空栈的栈顶元素），则会得到 **`ILLEGAL_ACCESS`** 的运行时错误提示信息。

## 自动机
一个 Luogu 3.0++ 程序的核心是自动机部分。
自动机由有限个状态（包括恰好一个初始状态），每个状态的类型，和这些状态之间的转移方式构成。
状态数量最多不能超过 ${10}^5$ 个，如果多于这个值，则会得到 **`TOO_MANY_STATES`** 的编译错误提示信息。
令状态数量为 $n$，所有状态依次编号为 $1 \sim n$。
每个状态均有自身的类型，状态的类型可以是如下若干类之一：

| 类型 | 格式与参数 | 具体描述 | 额外参数限制 |
|:-:|:-:|:-:|:-:|
| 常数入栈 | `PUS X1 V1 Q1` | 对栈 `X1` 进行入栈操作，推入值 `V1`，然后转移到状态 `Q1` | 无 |
| 出栈 | `POP X1 Q1` | 对栈 `X1` 进行出栈操作，然后转移到状态 `Q1` | 无 |
| 移动 | `MOV X1 X2 Q1` | 对栈 `X1` 进行入栈操作，推入栈 `X2` 的栈顶元素，然后对栈 `X2` 进行出栈操作，然后转移到状态 `Q1` | 无 |
| 复制 | `CPY X1 X2 Q1` | 对栈 `X1` 进行入栈操作，推入栈 `X2` 的栈顶元素，然后转移到状态 `Q1` | 无 |
| 加法 | `ADD X1 X2 X3 Q1` | 对栈 `X1` 进行入栈操作，推入栈 `X2` 的栈顶元素**加上**栈 `X3` 的栈顶元素的结果（模 $p$ 意义下），然后转移到状态 `Q1` | 无 |
| 减法 | `SUB X1 X2 X3 Q1` | 对栈 `X1` 进行入栈操作，推入栈 `X2` 的栈顶元素**减去**栈 `X3` 的栈顶元素的结果（模 $p$ 意义下），然后转移到状态 `Q1` | 无 |
| 乘法 | `MUL X1 X2 X3 Q1` | 对栈 `X1` 进行入栈操作，推入栈 `X2` 的栈顶元素**乘以**栈 `X3` 的栈顶元素的结果（模 $p$ 意义下），然后转移到状态 `Q1` | 无 |
| 整数除法 | `DIV X1 X2 X3 Q1` | 对栈 `X1` 进行入栈操作，推入栈 `X2` 的栈顶元素**除以**栈 `X3` 的栈顶元素的结果，**向下取整**，然后转移到状态 `Q1` | 如果栈 `X3` 的栈顶元素为 $0$，则会得到 **`DIVIDE_BY_ZERO`** 的运行时错误提示信息 |
| 整数取模 | `MOD X1 X2 X3 Q1` | 对栈 `X1` 进行入栈操作，推入栈 `X2` 的栈顶元素**对**栈 `X3` 的栈顶元素**取模**得到的结果，然后转移到状态 `Q1` | 如果栈 `X3` 的栈顶元素为 $0$，则会得到 **`DIVIDE_BY_ZERO`** 的运行时错误提示信息 |
| 空栈分支 | `EMP X1 Q1 Q2` | 如果栈 `X1` 为空栈，则转移到状态 `Q1`，否则转移到状态 `Q2` | 无 |
| 比较分支 | `CMP X1 X2 Q1 Q2` | 如果栈 `X1` 的栈顶元素**小于等于**栈 `X2` 的栈顶元素，则转移到状态 `Q1`，否则转移到状态 `Q2` | 无 |
| 终止 | `TER` | 终止程序 | 无 |

未特殊说明时：上表中的参数 `X1`、`X2` 和 `X3` 仅能取字符 `A`、`B` 或 `C` 之一，表示对应栈的编号；参数 `V1` 仅能取 $[0, p)$ 内的整数；参数 `Q1` 和 `Q2` 仅能取 $1 \sim n$ 之间的整数，表示对应状态的编号。
程序运行的流程如下：
1. 令“当前状态”为初始状态（应在自动机中唯一给定），令计数器 $c = 0$。
2. 令计数器 $c \gets c + 1$。如果此时 $c > {10}^6$，则会得到 **`TIME_LIMIT_EXCEEDED`** 的时间超限提示信息。
3. 执行“当前状态”对应的上表中的“**具体描述**”一列中的操作。
4. 如果“**具体描述**”一列中有“转移到状态 `Qx`”的操作，则令“当前状态”为状态 `Qx`，转到第 2 步。
5. 否则“当前状态”的类型为“终止”，终止程序。
## 源代码
为了能够使用 Luogu 3.0++ 编写代码，自动机的结构以文本的形式存储，格式如下：
- 第一行，两个正整数 $n, q_0$，分别表示自动机的状态数，以及初始状态编号。其中必须保证 $1 \le q_0 \le n$。
- 接下来 $n$ 行，第 $i$ 行描述编号为 $i$ 的状态，格式必须遵循上表中的“**格式与参数**”一列。
- 除此之外不允许有多余的文本。
## 输入与输出
Luogu 3.0++ 并没有显式的输入和输出流，而是通过程序运行时前后栈内的信息完成输入与输出。
在给定一个问题时，一般要规定输入格式和输出格式，在 Luogu 3.0++ 中，一般通过如下形式给出：
> **输入格式：**
> 
> 在程序开始运行前，栈中信息以如下方式存储：  
> （上一行可省略）
> 
> 栈 A 包含 $n + 1$ 个元素，自栈顶至栈底，依次为：$n, a_1, a_2, \ldots , a_n$。
> 
> 栈 B 与栈 C 均为空栈。
> 
> **输出格式：**
> 
> 在程序运行结束后，你应保证栈中信息以如下方式存储：  
> （上一行可省略）
> 
> 栈 A 应包含 $n$ 个元素，自栈顶至栈底，依次为：$a_n, a_{n - 1}, \ldots, a_1$。
> 
> 栈 B 与栈 C 均应为空栈。

程序运行结束后，会检查栈中元素是否符合要求，如果符合要求即算作成功解决问题。
## 源代码示例
### Cat Program
此源代码描述的 Luogu 3.0++ 程序将输入不做任何改变地输出。
```plain
1 1
TER
```
### A+B Problem
**问题描述**：给定两个整数 $a, b$，令 $c = (a + b) \bmod p$，求出 $c$ 的值。  
**数据范围**：$0 \le a, b < p$。
此源代码描述的 Luogu 3.0++ 程序的输入和输出格式如下：
> **输入格式：**
> 
> 栈 A 包含两个元素，自栈顶至栈底，依次为：$a, b$。栈 B 与栈 C 均为空栈。
> 
> **输出格式：**
> 
> 栈 A 应包含一个元素，自栈顶至栈底，依次为：$c$。栈 B 与栈 C 均应为空栈。

```plain
6 1
MOV B A 2
MOV C A 3
ADD A B C 4
POP B 5
POP C 6
TER
```
## 结语
如读者所见，Luogu 3.0++ 是一门语法清晰易懂、编写简便、程序逻辑灵活、功能强大的计算机语言。
我们期待着这一新兴语言在未来发展前景向好的计算机编程领域崭露头角，一起来用 Luogu 3.0++ 编写程序吧！
